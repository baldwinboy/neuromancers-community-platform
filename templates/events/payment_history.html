{% extends "base.html" %}

{% load i18n heroicons %}

{% block title %}
    {% trans "Payment History" %}
{% endblock title %}

{% block body_class %}
    template-payment-history
{% endblock body_class %}

{% block content %}
    <main class="payment-history">
        {# Back button #}
        <a href="{% url 'accounts_user_settings' %}" class="back-link">
            {% heroicon_mini "arrow-left" size=18 %}
            <span class="font-body">{% trans "Back to Settings" %}</span>
        </a>
        <h1 class="payment-history__title font-heading">{% trans "Payment History" %}</h1>
        {% if payments %}
            <div class="payment-history__list">
                {% for payment in payments %}
                    <article class="payment-history__card {% if payment.refunded %}payment-history__card--refunded{% elif payment.refund_status == 1 %}payment-history__card--refund-pending{% else %}payment-history__card--paid{% endif %}">
                        <div class="payment-history__card-header">
                            <div class="payment-history__card-info">
                                <h3 class="payment-history__card-title font-heading">{{ payment.session.title }}</h3>
                                <p class="payment-history__card-meta font-body">
                                    {% trans "Host" %}: {{ payment.session.host.first_name }} {{ payment.session.host.last_name }}
                                    (@{{ payment.session.host.username }})
                                </p>
                            </div>
                            <div class="payment-history__card-price-block">
                                <span class="payment-history__card-price font-heading">{{ payment.session.currency_symbol }}{{ payment.display_price }}</span>
                                {% if payment.refunded %}
                                    <span class="payment-history__status payment-history__status--refunded">
                                        {% heroicon_mini "arrow-uturn-left" size=12 %}
                                        {% trans "Refunded" %}
                                    </span>
                                {% elif payment.refund_status == 1 %}
                                    <span class="payment-history__status payment-history__status--refund-pending">
                                        {% heroicon_mini "clock" size=12 %}
                                        {% trans "Refund Pending" %}
                                    </span>
                                {% else %}
                                    <span class="payment-history__status payment-history__status--paid">
                                        {% heroicon_mini "check-circle" size=12 %}
                                        {% trans "Paid" %}
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="payment-history__card-body">
                            <dl class="payment-history__details">
                                <div class="payment-history__detail">
                                    <dt>{% trans "Date Paid" %}</dt>
                                    <dd>
                                        {{ payment.created_at|date:"SHORT_DATETIME_FORMAT" }}
                                    </dd>
                                </div>
                                <div class="payment-history__detail">
                                    <dt>{% trans "Session Date" %}</dt>
                                    <dd>
                                        {% if payment.display_starts_at %}
                                            {{ payment.display_starts_at|date:"D, M j" }} ·
                                            {{ payment.display_starts_at|time:"g:i A" }} – {{ payment.display_ends_at|time:"g:i A" }}
                                        {% else %}
                                            —
                                        {% endif %}
                                    </dd>
                                </div>
                                {% if payment.display_language %}
                                    <div class="payment-history__detail">
                                        <dt>{% trans "Language" %}</dt>
                                        <dd>
                                            {{ payment.display_language }}
                                        </dd>
                                    </div>
                                {% endif %}
                                <div class="payment-history__detail">
                                    <dt>{% trans "Payment ID" %}</dt>
                                    <dd class="payment-history__payment-id">
                                        {{ payment.stripe_payment_intent_id|truncatechars:24 }}
                                    </dd>
                                </div>
                            </dl>
                        </div>
                        {# Actions row #}
                        {% if payment.meeting_link or not payment.refunded and payment.refund_status == 0 %}
                            <div class="payment-history__card-actions">
                                {% if payment.meeting_link %}
                                    <a href="{{ payment.meeting_link }}"
                                       target="_blank"
                                       class="payment-history__action-btn payment-history__action-btn--join">
                                        {% heroicon_mini "video-camera" size=16 %}
                                        {% trans "Join Session" %}
                                    </a>
                                {% endif %}
                                {% if not payment.refunded and payment.refund_status == 0 %}
                                    <form method="post"
                                          action="{% url 'request_refund' payment.id %}"
                                          class="inline">
                                        {% csrf_token %}
                                        <button type="submit"
                                                class="payment-history__action-btn payment-history__action-btn--refund"
                                                onclick="return confirm('{% trans "Are you sure you want to request a refund?" %}')">
                                            {% heroicon_mini "arrow-uturn-left" size=16 %}
                                            {% trans "Request Refund" %}
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                        {% endif %}
                    </article>
                {% endfor %}
            </div>
            {% if is_paginated %}
                <nav class="payment-history__pagination"
                     aria-label="{% trans "Pagination" %}">
                    {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}"
                           class="inline_button inline_button_sm inline_button__sessions_alt">{% trans "Previous" %}</a>
                    {% endif %}
                    <span class="payment-history__page-info font-body">
                        {% trans "Page" %} {{ page_obj.number }} {% trans "of" %} {{ page_obj.paginator.num_pages }}
                    </span>
                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}"
                           class="inline_button inline_button_sm inline_button__sessions_alt">{% trans "Next" %}</a>
                    {% endif %}
                </nav>
            {% endif %}
        {% else %}
            <div class="payment-history__empty">
                {% heroicon_outline "banknotes" size=48 %}
                <p>{% trans "No payment history yet." %}</p>
            </div>
        {% endif %}
    </main>
{% endblock content %}
