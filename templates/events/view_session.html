{% extends "base.html" %}

{% load i18n l10n account guardian_tags wagtailroutablepage_tags %}

{% block title %}
    {{ page.session.title }}
{% endblock title %}

{% block description %}
    {{ page.session.description }}
{% endblock description %}

{% block body_class %}
    flex flex-col sessions_create sessions_view
{% endblock body_class %}

{% block content %}
    {% get_obj_perms request.user for page.session as "session_perms" %}
    <div class="flex flex-col flex-grow items-center gap-4 w-full h-full">
        <div class="w-full bg-lightAccent  py-9 ">
            <header class="flex flex-col justify-start items-center gap-4 w-full container mx-auto px-6 lg:px-0 lg:flex-row lg:justify-space-between">
                <h1 class="uppercase">{{ page.session.title }}</h1>
                {% if user.is_authenticated %}
                    {% if "change_peersession" in session_perms or "change_groupsession" in session_perms  %}
                    <div class="flex gap-4">
                        <a href="{% routablepageurl sessions_index "edit_session" session_type=page.session_type session_id=page.session.id %}"
                           class="auth_button auth_button__sessions block text-center">{% trans "Edit" %}</a>
                        {% if page.session_type == "peer" and "manage_availability" in session_perms %}
                            <a href="{% routablepageurl sessions_index "manage_availability" session_id=page.session.id %}"
                               class="auth_button auth_button__sessions block text-center">{% trans "Manage availability" %}</a>
                        {% endif %}
                        {% if form %}
                            <form method="post">
                                {% csrf_token %}
                                <div class="hidden" aria-hidden="true">{{ form.is_published }}</div>
                                <button class="auth_button auth_button__sessions block text-center">
                                    {% if page.session.is_published %}
                                        {% trans "Unpublish" %}
                                    {% else %}
                                        {% trans "Publish" %}
                                    {% endif %}
                                </button>
                            </form>
                        {% endif %}
                    </div>
                    {% endif %}
                {% endif %}
            </header>
            <a href="{% url "accounts_user_profile" username=page.session.host.username %}">
                <h2 class="w-full container mx-auto px-6 text-darkAccent lg:px-0">{{ page.session.host }}</h2>
            </a>
        </div>
        <main class="flex flex-col w-full h-full container mx-auto py-9 px-6 lg:px-0">
            {% trans "Introduction" as accordion_heading %}
            {% with accordion_name="details-group" accordion_classes="view_session__details_group" %}
                {% accordion %}
                <p class="font-body mb-8">{{ page.session.description }}</p>
                {% endaccordion %}
            {% endwith %}
            {% if page.session_type == "group" %}
            {% trans "Schedule" as accordion_heading %}
            {% with accordion_name="details-group" accordion_classes="view_session__details_group" %}
                {% accordion %}
                <p class="font-body mb-8"><time datetime="{{ session_request.starts_at|date:"c" }}">{% localize on %}{{ session_request.starts_at|date:"DATETIME_FORMAT" }}{% endlocalize %}</time> - <time datetime="{{ session_request.ends_at|date:"c" }}">{% localize on %}{{ session_request.ends_at|date:"DATETIME_FORMAT" }}{% endlocalize %}</time></p>
                {% endaccordion %}
            {% endwith %}
            {% endif %}
            {% trans "Pricing" as accordion_heading %}
            {% with accordion_name="details-group" accordion_classes="view_session__details_group" %}
                {% accordion %}
                <div class="mb-8">
                    <p class="text-xl font-body mt-4">{% trans "Standard price:" %} {{ page.session.currency_symbol }}{{ page.session.price_display }}</p>
                    {% if page.session.concessionary_price %}
                        <p class="text-xl font-body">{% trans "Consessionary price:" %} {{ page.session.currency_symbol }}{{ page.session.concessionary_price_display }}</p>
                    {% endif %}
                    {% if page.session.per_hour_price or page.session.concessionary_per_hour_price %}
                        <h4 class="text-3xl font-subheading mt-8">{% trans "Hourly rates" %}</h4>
                        <p class="font-body mb-4">{% trans "This is how much you'll pay in proportion to the length of your session." %}</p>
                        {% if page.session.per_hour_price %}
                            <p class="text-xl font-body">{% trans "Standard hourly rate:" %} {{ page.session.currency_symbol }}{{ page.session.per_hour_price_display }}</p>
                            {% if page.session.concessionary_per_hour_price %}
                            <p class="text-xl font-body">{% trans "Standard hourly rate:" %} {{ page.session.currency_symbol }}{{ page.session.concessionary_per_hour_price_display }}</p>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                </div>
                {% endaccordion %}
            {% endwith %}
            {% if page.session.durations %}
                {% trans "Durations" as accordion_heading %}
                {% with accordion_name="details-group" accordion_classes="view_session__details_group" %}
                    {% accordion %}
                    <p class="mt-4 font-body">{% trans "You may schedule sessions for the following amounts of time:" %}</p>
                    <ul class="mb-4">
                    {% for duration in page.session.durations_display %}
                        <li class="text-2xl">{{ duration }}</li>
                    {% empty %}
                        <li class="text-2xl">No durations available.</li>
                    {% endfor %}
                    </ul>
                    {% endaccordion %}
                {% endwith %}
            {% endif %}
        {% if "change_peersession" not in session_perms and "change_groupsession" not in session_perms %}
            {% if page.session_type == "peer" and "request_session" in session_perms %}
                <a href="{% routablepageurl sessions_index "request_schedule_session" session_id=page.session.id %}"
                class="auth_button auth_button__sessions block text-center mt-8 mx-auto">{% trans "Schedule a session" %}</a>
            {% elif page.session_type == "group" and "request_join_session" in session_perms %}
                {% if attendee_approved and page.session.meeting_link %}
                    <a href="{{ meeting_link }}"
                    class="auth_button auth_button__sessions block text-center mt-8 mx-auto">{% trans "Join session" %}</a>
                {% elif attendee_approved and not page.session.meeting_link %}
                    <div class="auth_button auth_button__sessions_disabled block text-center mt-8 mx-auto">{% trans "Join session" %}</div>
                    <small class="text-xl text-darkAccent w-3/4 mx-auto text-center mt-4">{% trans "You'll be able to join this session once a meeting link is available." %}</small>
                    {% elif attendee_requested %}
                    <div class="auth_button auth_button__sessions_disabled block text-center mt-8 mx-auto">{% trans "Join session" %}</div>
                    <small class="text-xl text-darkAccent w-3/4 mx-auto text-center mt-4">{% trans "You've requested to join the session. You'll be able to join once a meeting link is available." %}</small>
                {% elif form %}
                    <form method="post" class="mt-8">
                        {% csrf_token %}
                        <div class="create_session__field_item create_session__field_item_solo w-fit mx-auto pb-8">
                            {{ form.pay_concessionary_price.errors }}
                            <div class="flex flex-wrap">
                                {% if form.pay_concessionary_price.id_for_label %}
                                    <label for="{{ form.pay_concessionary_price.id_for_label }}" class="text-2xl">{{ form.pay_concessionary_price.label }}</label>
                                {% else %}
                                    <label for="id_{{ form.pay_concessionary_price.name }}_0" class="text-2xl">{{ form.pay_concessionary_price.label }}</label>
                                {% endif %}
                                {{ form.pay_concessionary_price }}
                                <p class="create_session__field_item_help_text w-full font-subheading font-light">{{ form.pay_concessionary_price.help_text }}</p>
                            </div>
                        </div>
                        <button type="submit" class="auth_button auth_button__sessions block text-center mx-auto">
                            {% trans "Join session" %}
                        </button>
                    </form>
                {% endif %}
            {% endif %}
        {% endif %}
    </main>
</div>
{% endblock content %}
