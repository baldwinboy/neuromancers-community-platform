{% extends "base.html" %}

{% load i18n heroicons %}

{% block body_class %}
    template-notification-inbox
{% endblock body_class %}

{% block title %}
    {% trans "Notifications" %}
{% endblock title %}

{% block content %}
    <main class="notification-inbox">
        <a href="{% url 'accounts_profile' %}" class="back-link">
            {% heroicon_mini "arrow-left" size=16 %}
            <span>{% trans "Back to profile" %}</span>
        </a>
        <header class="notification-inbox__header">
            <div class="notification-inbox__header-info">
                <h1 class="notification-inbox__title font-heading">{% trans "Notifications" %}</h1>
                {% if unread_count %}
                    <p class="notification-inbox__subtitle font-body">
                        {% blocktrans count counter=unread_count %}
                            {{ counter }} unread notification
                        {% plural %}
                            {{ counter }} unread notifications
                        {% endblocktrans %}
                    </p>
                {% endif %}
            </div>
            <div class="notification-inbox__actions">
                {% if unread_count %}
                    <button onclick="markAllRead()"
                            class="inline_button inline_button_sm inline_button__sessions"
                            aria-label="{% trans "Mark all notifications as read" %}">
                        {% heroicon_mini "check" size=14 %}
                        {% trans "Mark all read" %}
                    </button>
                {% endif %}
                {% if notifications %}
                    <button onclick="clearNotifications()"
                            class="inline_button inline_button_sm inline_button__sessions_alt"
                            aria-label="{% trans "Clear all read notifications" %}">
                        {% heroicon_mini "trash" size=14 %}
                        {% trans "Clear read" %}
                    </button>
                {% endif %}
            </div>
        </header>
        {# Notifications list #}
        {% if notifications %}
            <ul class="notification-inbox__list"
                role="list"
                aria-label="{% trans "Notifications" %}">
                {% for notification in notifications %}
                    <li class="notification-inbox__item {% if not notification.read %}notification-inbox__item--unread{% endif %}"
                        role="listitem">
                        {% if notification.link_url %}
                            <a href="{{ notification.link_url }}"
                               class="notification-inbox__item-link"
                               aria-label="{{ notification.get_subject_display }}: {{ notification.body|striptags|truncatewords:10 }}">
                            {% endif %}
                            <div class="notification-inbox__item-indicator" aria-hidden="true">
                                {% if notification.subject == 0 %}
                                    {% heroicon_mini "user-circle" size=20 %}
                                {% elif notification.subject == 1 %}
                                    {% heroicon_mini "credit-card" size=20 %}
                                {% elif notification.subject == 2 %}
                                    {% heroicon_mini "calendar" size=20 %}
                                {% else %}
                                    {% heroicon_mini "bell" size=20 %}
                                {% endif %}
                            </div>
                            <div class="notification-inbox__item-content">
                                <h2 class="notification-inbox__item-subject font-subheading">{{ notification.get_subject_display }}</h2>
                                <p class="notification-inbox__item-body font-body">{{ notification.body|striptags }}</p>
                                <time class="notification-inbox__item-time font-body"
                                      datetime="{{ notification.sent_at|date:'c' }}">
                                    {{ notification.sent_at|date:"SHORT_DATETIME_FORMAT" }}
                                </time>
                            </div>
                            {% if notification.link_url %}</a>{% endif %}
                        {% if not notification.read %}
                            <button onclick="event.stopPropagation(); markRead('{{ notification.id }}')"
                                    class="notification-inbox__item-action"
                                    aria-label="{% blocktrans with subject=notification.get_subject_display %}Mark {{ subject }} notification as read{% endblocktrans %}">
                                {% heroicon_mini "check-circle" size=18 %}
                                <span>{% trans "Mark read" %}</span>
                            </button>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
            {# Pagination #}
            {% if page_obj.has_other_pages %}
                <nav class="notification-inbox__pagination"
                     aria-label="{% trans "Pagination" %}">
                    {% if page_obj.has_previous %}
                        <a href="?page=1"
                           class="inline_button inline_button_sm inline_button__sessions_alt"
                           aria-label="{% trans "First page" %}">{% trans "First" %}</a>
                        <a href="?page={{ page_obj.previous_page_number }}"
                           class="inline_button inline_button_sm inline_button__sessions_alt"
                           aria-label="{% trans "Previous page" %}">
                            {% heroicon_mini "chevron-left" size=14 %}
                            {% trans "Previous" %}
                        </a>
                    {% endif %}
                    <span class="notification-inbox__pagination-info font-body"
                          aria-current="page">
                        {% trans "Page" %} {{ page_obj.number }} {% trans "of" %} {{ page_obj.paginator.num_pages }}
                    </span>
                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}"
                           class="inline_button inline_button_sm inline_button__sessions_alt"
                           aria-label="{% trans "Next page" %}">
                            {% trans "Next" %}
                            {% heroicon_mini "chevron-right" size=14 %}
                        </a>
                        <a href="?page={{ page_obj.paginator.num_pages }}"
                           class="inline_button inline_button_sm inline_button__sessions_alt"
                           aria-label="{% trans "Last page" %}">{% trans "Last" %}</a>
                    {% endif %}
                </nav>
            {% endif %}
        {% else %}
            <div class="notification-inbox__empty">
                {% heroicon_outline "bell-slash" size=48 %}
                <p class="notification-inbox__empty-title font-subheading">{% trans "No notifications yet" %}</p>
                <p class="notification-inbox__empty-hint font-body">
                    {% trans "You'll see notifications about your sessions and payments here." %}
                </p>
            </div>
        {% endif %}
    </main>
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function markRead(notificationId) {
            const response = await fetch(`/notifications/${notificationId}/mark-read/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                location.reload();
            }
        }

        async function markAllRead() {
            const response = await fetch('/notifications/mark-all-read/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                location.reload();
            }
        }

        async function clearNotifications() {
            if (confirm('{% trans "Delete all read notifications?" %}')) {
                const response = await fetch('/notifications/clear/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    location.reload();
                }
            }
        }
    </script>
{% endblock content %}
